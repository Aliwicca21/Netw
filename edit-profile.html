<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
<link rel="stylesheet" href="star.css">
</head>
<body>
<div class="language-selector">
  <select id="lang-select">
    <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    <option value="en">English</option>
  </select>
</div>

<div class="card">
  <h2 id="title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
  <form id="profile-form">
    <label id="label-photo">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
    <img id="profile-preview" class="profile-preview" src="https://via.placeholder.com/120" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
    <input type="file" id="profile-pic" accept="image/*">
    <button type="button" id="remove-pic" class="btn btn-danger">ğŸ—‘ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>

    <label id="label-fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input type="text" id="fullname">

    <label id="label-email">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
    <input type="email" id="email">

    <label id="label-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="text" id="phone">

    <label id="label-birthdate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
    <input type="date" id="birthdate">

    <button type="submit" class="btn btn-primary" id="save-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <a href="profile.html" class="btn btn-secondary" id="back-btn">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
  authDomain: "fir-dba4c.firebaseapp.com",
  projectId: "fir-dba4c",
  storageBucket: "fir-dba4c.appspot.com",
  messagingSenderId: "160255207915",
  appId: "1:160255207915:web:ce8e69d43f62daf476d1ae",
  measurementId: "G-GYPNMR85G2"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
const profilePreview = document.getElementById('profile-preview');
const profilePicInput = document.getElementById('profile-pic');
const removePicBtn = document.getElementById('remove-pic');

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
profilePicInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (event)=> profilePreview.src = event.target.result;
    reader.readAsDataURL(file);
  }
});

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
removePicBtn.addEventListener('click', async ()=>{
  if(!currentUser) return;
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©ØŸ")) return;
  const storageReference = storageRef(storage,'profile_pics/'+currentUser.uid);
  try{ await deleteObject(storageReference); } catch(e){ console.warn(e); }
  profilePreview.src="https://via.placeholder.com/120";
  profilePicInput.value="";
});

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    const docRef = doc(db,"users",currentUser.uid);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      document.getElementById("fullname").value = data.fullname||"";
      document.getElementById("email").value = data.email||"";
      document.getElementById("phone").value = data.phone||"";
      document.getElementById("birthdate").value = data.birthdate||"";
      if(data.photoURL) profilePreview.src = data.photoURL;
    }
  } else { window.location.href="index.html"; }
});

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
document.getElementById('profile-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser) return;
  const fullname=document.getElementById("fullname").value;
  const email=document.getElementById("email").value;
  const phone=document.getElementById("phone").value;
  const birthdate=document.getElementById("birthdate").value;
  let photoURL=null;
  const file = profilePicInput.files[0];
  if(file){
    try{
      const storageReference = storageRef(storage,'profile_pics/'+currentUser.uid);
      await uploadBytes(storageReference,file);
      photoURL = await getDownloadURL(storageReference);
    }catch(err){ alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); return; }
  }
  if(profilePreview.src.endsWith("placeholder.com/120")) photoURL=null;
  const updateData = {fullname,email,phone,birthdate};
  if(photoURL) updateData.photoURL=photoURL;
  else updateData.photoURL="";
  await setDoc(doc(db,"users",currentUser.uid),updateData,{merge:true});
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
  window.location.href="profile.html";
});

// ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
const translations={
  ar:{title:"âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",photo:"Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©",fullname:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",email:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„",phone:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",birthdate:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯",save:"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª",back:"â†©ï¸ Ø±Ø¬ÙˆØ¹"},
  en:{title:"âœï¸ Edit Profile",photo:"Profile Photo",fullname:"Full Name",email:"Email",phone:"Phone Number",birthdate:"Birthdate",save:"ğŸ’¾ Save Changes",back:"â†©ï¸ Back"}
};
const langSelect=document.getElementById("lang-select");
langSelect.addEventListener("change",()=>{
  const lang=langSelect.value;
  document.getElementById("title").innerText=translations[lang].title;
  document.getElementById("label-photo").innerText=translations[lang].photo;
  document.getElementById("label-fullname").innerText=translations[lang].fullname;
  document.getElementById("label-email").innerText=translations[lang].email;
  document.getElementById("label-phone").innerText=translations[lang].phone;
  document.getElementById("label-birthdate").innerText=translations[lang].birthdate;
  document.getElementById("save-btn").innerText=translations[lang].save;
  document.getElementById("back-btn").innerText=translations[lang].back;
  document.body.dir = lang==="ar"?"rtl":"ltr";
});
</script>
</body>
</html>
