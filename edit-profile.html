<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تعديل الملف الشخصي</title>
<link rel="stylesheet" href="star.css">
</head>
<body>
<div class="language-selector">
  <select id="lang-select">
    <option value="ar" selected>العربية</option>
    <option value="en">English</option>
  </select>
</div>

<div class="card">
  <h2 id="title">✏️ تعديل الملف الشخصي</h2>
  <form id="profile-form">
    <label id="label-photo">الصورة الشخصية</label>
    <img id="profile-preview" class="profile-preview" src="https://via.placeholder.com/120" alt="معاينة الصورة">
    <input type="file" id="profile-pic" accept="image/*">
    <button type="button" id="remove-pic" class="btn btn-danger">🗑 إزالة الصورة</button>

    <label id="label-fullname">الاسم الكامل</label>
    <input type="text" id="fullname">

    <label id="label-email">الإيميل</label>
    <input type="email" id="email">

    <label id="label-phone">رقم الهاتف</label>
    <input type="text" id="phone">

    <label id="label-birthdate">تاريخ الميلاد</label>
    <input type="date" id="birthdate">

    <button type="submit" class="btn btn-primary" id="save-btn">💾 حفظ التعديلات</button>
    <a href="profile.html" class="btn btn-secondary" id="back-btn">↩️ رجوع</a>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
  authDomain: "fir-dba4c.firebaseapp.com",
  projectId: "fir-dba4c",
  storageBucket: "fir-dba4c.appspot.com",
  messagingSenderId: "160255207915",
  appId: "1:160255207915:web:ce8e69d43f62daf476d1ae",
  measurementId: "G-GYPNMR85G2"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
const profilePreview = document.getElementById('profile-preview');
const profilePicInput = document.getElementById('profile-pic');
const removePicBtn = document.getElementById('remove-pic');

// معاينة الصورة قبل الحفظ
profilePicInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (event)=> profilePreview.src = event.target.result;
    reader.readAsDataURL(file);
  }
});

// إزالة الصورة
removePicBtn.addEventListener('click', async ()=>{
  if(!currentUser) return;
  if(!confirm("هل تريد إزالة الصورة الشخصية؟")) return;
  const storageReference = storageRef(storage,'profile_pics/'+currentUser.uid);
  try{ await deleteObject(storageReference); } catch(e){ console.warn(e); }
  profilePreview.src="https://via.placeholder.com/120";
  profilePicInput.value="";
});

// تحميل بيانات المستخدم
onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    const docRef = doc(db,"users",currentUser.uid);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      document.getElementById("fullname").value = data.fullname||"";
      document.getElementById("email").value = data.email||"";
      document.getElementById("phone").value = data.phone||"";
      document.getElementById("birthdate").value = data.birthdate||"";
      if(data.photoURL) profilePreview.src = data.photoURL;
    }
  } else { window.location.href="index.html"; }
});

// حفظ البيانات
document.getElementById('profile-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser) return;
  const fullname=document.getElementById("fullname").value;
  const email=document.getElementById("email").value;
  const phone=document.getElementById("phone").value;
  const birthdate=document.getElementById("birthdate").value;
  let photoURL=null;
  const file = profilePicInput.files[0];
  if(file){
    try{
      const storageReference = storageRef(storage,'profile_pics/'+currentUser.uid);
      await uploadBytes(storageReference,file);
      photoURL = await getDownloadURL(storageReference);
    }catch(err){ alert("حدث خطأ أثناء رفع الصورة"); return; }
  }
  if(profilePreview.src.endsWith("placeholder.com/120")) photoURL=null;
  const updateData = {fullname,email,phone,birthdate};
  if(photoURL) updateData.photoURL=photoURL;
  else updateData.photoURL="";
  await setDoc(doc(db,"users",currentUser.uid),updateData,{merge:true});
  alert("✅ تم حفظ التعديلات بنجاح!");
  window.location.href="profile.html";
});

// تغيير اللغة
const translations={
  ar:{title:"✏️ تعديل الملف الشخصي",photo:"الصورة الشخصية",fullname:"الاسم الكامل",email:"الإيميل",phone:"رقم الهاتف",birthdate:"تاريخ الميلاد",save:"💾 حفظ التعديلات",back:"↩️ رجوع"},
  en:{title:"✏️ Edit Profile",photo:"Profile Photo",fullname:"Full Name",email:"Email",phone:"Phone Number",birthdate:"Birthdate",save:"💾 Save Changes",back:"↩️ Back"}
};
const langSelect=document.getElementById("lang-select");
langSelect.addEventListener("change",()=>{
  const lang=langSelect.value;
  document.getElementById("title").innerText=translations[lang].title;
  document.getElementById("label-photo").innerText=translations[lang].photo;
  document.getElementById("label-fullname").innerText=translations[lang].fullname;
  document.getElementById("label-email").innerText=translations[lang].email;
  document.getElementById("label-phone").innerText=translations[lang].phone;
  document.getElementById("label-birthdate").innerText=translations[lang].birthdate;
  document.getElementById("save-btn").innerText=translations[lang].save;
  document.getElementById("back-btn").innerText=translations[lang].back;
  document.body.dir = lang==="ar"?"rtl":"ltr";
});
</script>
</body>
</html>
