<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kalk.Bot - Login</title>
<link rel="stylesheet" href="alloush.css" />
<script type="module">
  // ---- Firebase ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  // ğŸ”§ Ø¶ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ (storageBucket Ø§Ù„ØµØ­ÙŠØ­ Ø¹Ø§Ø¯Ø©: <project-id>.appspot.com)
  const firebaseConfig = {
    apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
    authDomain: "fir-dba4c.firebaseapp.com",
    projectId: "fir-dba4c",
    storageBucket: "fir-dba4c.appspot.com",
    messagingSenderId: "160255207915",
    appId: "1:160255207915:web:ce8e69d43f62daf476d1ae",
    measurementId: "G-GYPNMR85G2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- ØªØ±Ø¬Ù…Ø© ----------
  const translations = {
    en: {
      title: "Login",
      identifier: "Email / Username / Phone",
      password: "Password",
      loginBtn: "Login",
      forgot: "Forgot password?",
      noAccount: "Don't have an account?",
      signup: "Create new account",
      missing: "Please enter all fields",
      nf: "User not found",
      perm: "Cannot read user index (permissions). See Firestore rules below.",
      resetNeedEmail: "Enter your email to reset password",
      resetSent: "Reset link sent to your email",
      unknownErr: "Something went wrong"
    },
    ar: {
      title: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
      identifier: "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ / Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ù‡Ø§ØªÙ",
      password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
      loginBtn: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
      forgot: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ",
      noAccount: "Ù…Ø§ Ø¹Ù†Ø¯ÙƒØ´ Ø­Ø³Ø§Ø¨ØŸ",
      signup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯",
      missing: "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„",
      nf: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯",
      perm: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª). Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¨Ø§Ù„Ø£Ø³ÙÙ„.",
      resetNeedEmail: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
      resetSent: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù„Ø¨Ø±ÙŠØ¯Ùƒ",
      unknownErr: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹"
    }
  };
  let currentLang = "en";

  // ---- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----
  const normalizePhone = (v) => v.replace(/[^\d]/g, ""); // Ø´ÙŠÙ„ Ø£ÙŠ Ø±Ù…ÙˆØ²
  const looksLikeEmail = (v) => v.includes("@");
  const looksLikePhone = (v) => {
    const d = normalizePhone(v);
    return d.length >= 7 && d.length <= 15;
  };

  // Ù‡Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† user_index:
  // - username:<lowercase>  -> { email }
  // - phone:<digits_only>   -> { email }
  async function getEmailFromIdentifier(identifier) {
    // Ù„Ùˆ Ø¥ÙŠÙ…ÙŠÙ„.. Ø®Ù„Ø§Øµ
    if (looksLikeEmail(identifier)) return identifier.trim();

    let key;
    if (looksLikePhone(identifier)) {
      key = `phone:${normalizePhone(identifier)}`;
    } else {
      key = `username:${identifier.trim().toLowerCase()}`;
    }

    try {
      const ref = doc(db, "user_index", key);
      const snap = await getDoc(ref);
      if (snap.exists() && snap.data().email) {
        return snap.data().email;
      }
      return null;
    } catch (e) {
      console.error(e);
      throw new Error("PERMISSION");
    }
  }

  // ---- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
  window.loginUnified = async (e) => {
    e.preventDefault();
    const t = translations[currentLang];

    const identifier = document.getElementById("identifier").value.trim();
    const password = document.getElementById("password").value;

    if (!identifier || !password) {
      alert(t.missing);
      return;
    }

    let emailToLogin = null;
    try {
      emailToLogin = await getEmailFromIdentifier(identifier);
    } catch (err) {
      if (err.message === "PERMISSION") {
        alert(t.perm);
        return;
      }
      alert(t.unknownErr);
      return;
    }

    if (!emailToLogin) {
      alert(t.nf);
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, emailToLogin, password);
      window.location.href = "profile.html";
    } catch (err) {
      alert(err.message || t.unknownErr);
    }
  };

  // ---- Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙŠØ­ØªØ§Ø¬ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ±ÙŠØ­) ----
  window.resetPassword = async () => {
    const t = translations[currentLang];
    const identifier = document.getElementById("identifier").value.trim();
    if (!looksLikeEmail(identifier)) {
      alert(t.resetNeedEmail);
      return;
    }
    try {
      await sendPasswordResetEmail(auth, identifier);
      alert(t.resetSent);
    } catch (err) {
      alert(err.message || t.unknownErr);
    }
  };

  // ---- ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© ----
  window.changeLanguage = (lang) => {
    currentLang = lang;
    document.documentElement.lang = lang;
    document.body.dir = lang === "ar" ? "rtl" : "ltr";

    const tt = translations[lang];
    document.getElementById("title").textContent = tt.title;
    document.getElementById("identifier").placeholder = tt.identifier;
    document.getElementById("password").placeholder = tt.password;
    document.getElementById("login-btn").textContent = tt.loginBtn;
    document.getElementById("forgot-link").textContent = tt.forgot;
    document.getElementById("no-account").firstChild.textContent = tt.noAccount + " ";
    document.getElementById("signup-link").textContent = tt.signup;
  };

  // set default UI
  window.addEventListener("DOMContentLoaded", () => changeLanguage("en"));
</script>
</head>
<body>
  <div class="language-selector">
    <select onchange="changeLanguage(this.value)">
      <option value="en" selected>English</option>
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>

  <div class="card">
    <h2 id="title">Login</h2>
    <form onsubmit="loginUnified(event)">
      <input type="text" id="identifier" placeholder="Email / Username / Phone" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit" id="login-btn">Login</button>
    </form>

    <div class="forgot-password">
      <a href="#" id="forgot-link" onclick="resetPassword()">Forgot password?</a>
    </div>

    <hr />

    <div class="signup-link">
      <p id="no-account">Don't have an account?
        <a href="register.html" id="signup-link">Create new account</a>
      </p>
    </div>
  </div>
</body>
</html>
