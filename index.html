<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kalk.Bot - Login</title>
<link rel="stylesheet" href="alloush.css" />
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
  authDomain: "fir-dba4c.firebaseapp.com",
  projectId: "fir-dba4c",
  storageBucket: "fir-dba4c.appspot.com",
  messagingSenderId: "160255207915",
  appId: "1:160255207915:web:ce8e69d43f62daf476d1ae",
  measurementId: "G-GYPNMR85G2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const normalizePhone = (v) => v.replace(/[^\d]/g, "");
const looksLikeEmail = (v) => v.includes("@");
const looksLikePhone = (v) => {
  const d = normalizePhone(v);
  return d.length >= 7 && d.length <= 15;
};

async function getEmailFromIdentifier(identifier) {
  if (looksLikeEmail(identifier)) return identifier.trim();

  let key;
  if (looksLikePhone(identifier)) {
    key = `phone:${normalizePhone(identifier)}`;
  } else {
    key = `username:${identifier.trim().toLowerCase()}`;
  }

  const ref = doc(db, "user_index", key);
  const snap = await getDoc(ref);
  if (snap.exists() && snap.data().email) {
    return snap.data().email;
  }
  return null;
}

window.loginUnified = async (e) => {
  e.preventDefault();
  const identifier = document.getElementById("identifier").value.trim();
  const password = document.getElementById("password").value;

  if (!identifier || !password) {
    alert("Please enter all fields");
    return;
  }

  const emailToLogin = await getEmailFromIdentifier(identifier);
  if (!emailToLogin) {
    alert("User not found");
    return;
  }

  try {
    await signInWithEmailAndPassword(auth, emailToLogin, password);
    window.location.href = "profile.html";
  } catch (err) {
    alert(err.message);
  }
};

window.resetPassword = async () => {
  const identifier = document.getElementById("identifier").value.trim();
  if (!looksLikeEmail(identifier)) {
    alert("Enter your email to reset password");
    return;
  }
  try {
    await sendPasswordResetEmail(auth, identifier);
    alert("Reset link sent to your email");
  } catch (err) {
    alert(err.message);
  }
};
</script>
</head>
<body>
  <div class="card">
    <h2>Login</h2>
    <form onsubmit="loginUnified(event)">
      <input type="text" id="identifier" placeholder="Email / Username / Phone" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <a href="#" onclick="resetPassword()">Forgot password?</a>
    <p>Don't have an account? <a href="register.html">Register</a></p>
  </div>
</body>
</html>
