<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kalk.Bot - Login</title>
  <link rel="stylesheet" href="alloush.css">
  <script type="module">
    // Firebase Import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      sendPasswordResetEmail 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey:"AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
      authDomain:"fir-dba4c.firebaseapp.com",
      projectId:"fir-dba4c",
      storageBucket:"fir-dba4c.firebasestorage.app",
      messagingSenderId:"160255207915",
      appId:"1:160255207915:web:ce8e69d43f62daf476d1ae",
      measurementId:"G-GYPNMR85G2"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // âœ… Ø§Ù„ØªØ±Ø¬Ù…Ø©
    const translations = {
      en: {
        title: "Login",
        identifier: "Email / Username / Phone",
        password: "Password",
        loginBtn: "Login",
        forgot: "Forgot password?",
        noAccount: "Don't have an account?",
        signup: "Create new account"
      },
      ar: {
        title: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
        identifier: "Ø§Ù„Ø¨Ø±ÙŠØ¯ / Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ù‡Ø§ØªÙ",
        password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        loginBtn: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
        forgot: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ",
        noAccount: "Ù…Ø§ Ø¹Ù†Ø¯ÙƒØ´ Ø­Ø³Ø§Ø¨ØŸ",
        signup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"
      }
    };

    let currentLang = "en";

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
    window.loginWithEmailOrUsername = async (e) => {
      e.preventDefault();
      const identifier = document.getElementById("identifier").value.trim();
      const password = document.getElementById("password").value;

      if (!identifier || !password) {
        alert("Please enter all fields");
        return;
      }

      let emailToLogin = identifier;

      // ðŸ“Œ Ù„Ùˆ ÙƒØªØ¨ ÙŠÙˆØ²Ø± Ù†ÙŠÙ… Ø£Ùˆ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ â†’ Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Firestore
      if (!identifier.includes("@")) {
        const usersRef = collection(db, "users");
        let q;

        if (/^\d+$/.test(identifier)) {
          // Ø±Ù‚Ù… Ù‡Ø§ØªÙ
          q = query(usersRef, where("phone", "==", identifier));
        } else {
          // ÙŠÙˆØ²Ø± Ù†ÙŠÙ…
          q = query(usersRef, where("username", "==", identifier));
        }

        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
          emailToLogin = querySnapshot.docs[0].data().email;
        } else {
          alert("User not found");
          return;
        }
      }

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
      signInWithEmailAndPassword(auth, emailToLogin, password)
        .then(() => {
          window.location.href = "profile.html";
        })
        .catch(err => alert(err.message));
    };

    // âœ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    window.resetPassword = () => {
      const identifier = document.getElementById("identifier").value.trim();
      if (!identifier.includes("@")) {
        alert("Please enter your email to reset password");
        return;
      }
      sendPasswordResetEmail(auth, identifier)
        .then(() => alert("Reset link sent to your email"))
        .catch(err => alert(err.message));
    };

    // âœ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
    window.changeLanguage = (lang) => {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.body.dir = (lang === "ar") ? "rtl" : "ltr";

      const t = translations[lang];
      document.getElementById("title").textContent = t.title;
      document.getElementById("identifier").placeholder = t.identifier;
      document.getElementById("password").placeholder = t.password;
      document.getElementById("login-btn").textContent = t.loginBtn;
      document.getElementById("forgot-link").textContent = t.forgot;
      document.getElementById("no-account").textContent = t.noAccount;
      document.getElementById("signup-link").textContent = t.signup;
    };
  </script>
</head>
<body>
  <div class="language-selector">
    <select onchange="changeLanguage(this.value)">
      <option value="en" selected>English</option>
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>

  <div class="card">
    <h2 id="title">Login</h2>
    <form onsubmit="loginWithEmailOrUsername(event)">
      <input type="text" id="identifier" placeholder="Email / Username / Phone" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit" id="login-btn">Login</button>
    </form>

    <div class="forgot-password">
      <a href="#" id="forgot-link" onclick="resetPassword()">Forgot password?</a>
    </div>
    <hr>
    <div class="signup-link">
      <p id="no-account">Don't have an account? 
        <a href="register.html" id="signup-link">Create new account</a>
      </p>
    </div>
  </div>
</body>
</html>
