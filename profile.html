<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>الملف الشخصي</title>
<link rel="stylesheet" href="style.css">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
  authDomain: "fir-dba4c.firebaseapp.com",
  databaseURL: "https://fir-dba4c-default-rtdb.firebaseio.com",
  projectId: "fir-dba4c",
  storageBucket: "fir-dba4c.firebasestorage.app",
  messagingSenderId: "160255207915",
  appId: "1:160255207915:web:ce8e69d43f62daf476d1ae"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const currentUserId = localStorage.getItem("currentUserId");

async function loadProfile(){
  if(!currentUserId) window.location.href = "login.html";
  const snapshot = await get(ref(db, `users/${currentUserId}`));
  const user = snapshot.val();
  document.getElementById("balance").innerText = user.balance || 0;
  document.getElementById("botStatus").innerText = user.botRunning ? "✅ البوت شغال" : "❌ البوت متوقف";
}

async function renewSubscription(months){
  const snapshot = await get(ref(db, `users/${currentUserId}`));
  const user = snapshot.val();
  const cost = months; // كل شهر = 1 دولار
  if((user.balance || 0) < cost){
    alert("الرصيد غير كافي!");
    return;
  }
  const newBalance = (user.balance || 0) - cost;
  await update(ref(db, `users/${currentUserId}`), { 
    balance: newBalance, 
    subscription_active: true,
    botRunning: true
  });
  alert("تم تجديد الاشتراك وتفعيل البوت!");
  loadProfile();
}

window.loadProfile = loadProfile;
window.renewSubscription = renewSubscription;
window.logout = () => {
  localStorage.removeItem("currentUserId");
  window.location.href = "login.html";
}

document.addEventListener("DOMContentLoaded", loadProfile);
</script>
</head>
<body>
<div class="card">
  <h2>الملف الشخصي</h2>
  <p>الرصيد الحالي: <span id="balance">0</span> دولار</p>
  <p>حالة البوت: <span id="botStatus">❌</span></p>
  <h3>تجديد الاشتراك:</h3>
  <button onclick="renewSubscription(1)">شهر (1$)</button>
  <button onclick="renewSubscription(2)">شهرين (2$)</button>
  <button onclick="renewSubscription(3)">3 أشهر (3$)</button>
  <button onclick="renewSubscription(12)">سنة (12$)</button>
  <button onclick="logout()">تسجيل الخروج</button>
  <button onclick="window.location.href='topup.html'">شحن الرصيد</button>
</div>
</body>
</html>
